<div class="w-100 h-100" style="height: calc(100vh) !important;overflow: auto;">
    <div class="d-flex align-items-center w-100 h-100 px-1" 
        [ngClass]="{
            'justify-content-start': isMobile,
            'justify-content-center': !isMobile,
            'flex-column': true
        }">
        
        <!-- Test URL -->
        <ng-container *ngIf="!isMobile && isLocalhost" [ngTemplateOutlet]="testTemplate"></ng-container>

        <div class="d-flex mt-1 mb-3" 
            [ngClass]="{
                'w-75': !(isMobile && portrait), 
                'w-100': isMobile && portrait                
            }">
            <ng-container *ngIf="channels.length>0 && streamForm">
                <form [formGroup]="streamForm" class="w-100 d-flex" [ngClass]="{'d-flex': !isMobile}">
                    <div 
                        [ngClass]="{
                            'w-50': !isMobile,
                            'w-100': isMobile 
                        }">
                        <ng-select
                            class="mb-2"
                            [items]="countries"
                            (ngModelChange)="doFilterByCountry(undefined)"
                            (clear)="doFilterByCountry()"
                            [hideSelected]="false"
                            formControlName="country"
                            [clearable]="true"
                            name="type"
                            bindValue="iso2"
                            bindLabel="name"
                            placeholder="Search a country">
                            <ng-template ng-label-tmp let-item="item">
                                <div class="d-flex align-items-center justify-content-start w-100">
                                    <i *ngIf="item.iso2.length>0" [title]="getCountryName(item.iso2)" class="me-2 fi fi-{{item.iso2}}"></i>
                                    {{item.name}} <small class="num_channels ms-2">({{item.numChannels}} channels)</small>
                                </div>
                            </ng-template>
                            <ng-template ng-option-tmp let-item="item" let-index="index">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                    <div>
                                        <i *ngIf="item.iso2.length>0" [title]="getCountryName(item.iso2)" class="me-2 fi fi-{{item.iso2}}"></i>
                                        {{item.name}}
                                    </div>
                                     <small class="num_channels ms-2">({{item.numChannels}} channels)</small>
                                </div>
                            </ng-template>
                        </ng-select>
                    </div>
                    <div 
                        [ngClass]="{
                            'w-50': !isMobile,
                            'w-100': isMobile,
                            'ps-1': !isMobile
                        }">
                        <ng-select
                            #channelSelector
                            [items]="channelsFiltered"
                            (ngModelChange)="doUpdateStreamUrl($event)"
                            [hideSelected]="false"
                            formControlName="channel"
                            name="type"
                            bindValue="name"
                            bindLabel="name"
                            placeholder="Search a channel">
                            <ng-template ng-label-tmp let-item="item">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                    <div class="d-flex align-items-center">
                                        <img [src]="item.logo" class="logo me-2">
                                        <div [ngClass]="{'wrap-200':isMobile}">{{item.name}}</div>
                                    </div>
                                    <i *ngIf="item.country?.length>0" [title]="getCountryName(item.country)" class="ms-auto fi fi-{{item.country}}"></i>
                                </div>
                            </ng-template>
                            <ng-template ng-option-tmp let-item="item" let-index="index">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <img [src]="item.logo" class="logo me-2">
                                        <div [ngClass]="{'wrap-200':isMobile}">{{item.name}}</div>
                                    </div>
                                    <div>
                                        <small class="me-2 country_name">{{item.country}}</small>
                                        <i *ngIf="item.country?.length>0" [title]="getCountryName(item.country)" class="ms-auto fi fi-{{item.country}}"></i>
                                    </div>
                                </div>
                            </ng-template>
                        </ng-select>
                    </div>
                    
                </form>
            </ng-container>
        </div>

        <div class="d-flex justify-content-between align-items-top" 
            [ngClass]="{
                'w-75': !(isMobile && portrait), 
                'w-100': isMobile && portrait,
                'flex-column': isMobile && portrait
            }">
            
            <ng-container *ngIf="!(isMobile && portrait) && history.length>0" [ngTemplateOutlet]="historyTemplate"></ng-container>

            <div class="d-flex flex-column justify-content-start align-items-top" 
                [ngClass]="{
                    'w-85': !(isMobile && portrait) && history.length>0, 
                    'w-100': (isMobile && portrait) || history.length===0
                }">
                <ng-container *ngIf="streamUrl">

                    <ng-container [ngTemplateOutlet]="player" [ngTemplateOutletContext]="{
                        url: streamUrl,
                        format: currentFormat,
                        youtubeId: youtubeVideoId,
                        logo: logoUrl
                    }"></ng-container>
                    
                </ng-container>
                <ng-container *ngIf="(!streamUrl || streamUrl.length===0) && (!isMobile || isTablet)">
                    <ng-container [ngTemplateOutlet]="mosaic"></ng-container>
                </ng-container>
            </div>
            <ng-container *ngIf="isMobile && portrait && history.length>0" [ngTemplateOutlet]="historyTemplate"></ng-container>
            
        </div>
    </div>
</div>

<ng-template #testTemplate>
    <div class="d-flex justify-content-start align-items-center w-75">
        <div class="form-group w-100 d-flex mt-1 mb-1">
            <input type="text" (keyup)="doTestURL()" id="testURL" placeholder="Enter a valid .m3u8 or youtube format url" class="form-control" [(ngModel)]="testURL">
        </div>
    </div>
</ng-template>

<!-- Direct access Template-->
<ng-template #historyTemplate>
    
        <div class="d-flex justify-content-around" 
            [ngClass]="{
                'w-15': !(isMobile && portrait), 
                'w-100': isMobile && portrait,
                'flex-column': !(isMobile && portrait),
                'mt-2': isMobile && portrait,
            }">
            <form [formGroup]="gridViewForm" class="no-borders" [ngClass]="{'mb-2': !(isMobile && portrait)}">
                <ng-select
                    [items]="gridViewTypesFormValues"
                    [hideSelected]="false"
                    formControlName="gridViewType"
                    [clearable]="false"
                    name="gridViewType"
                    bindValue="value"
                    bindLabel="text">
                    <ng-template ng-label-tmp let-item="item">
                        <div class="d-flex align-items-center justify-content-start w-100">
                            {{item.text}}
                        </div>
                    </ng-template>
                    <ng-template ng-option-tmp let-item="item" let-index="index">
                        <div class="d-flex align-items-center justify-content-start w-100">
                            {{item.text}}
                        </div>
                    </ng-template>
                </ng-select>
            </form>
            <ng-container *ngIf="gridViewForm.get('gridViewType')?.value===GridViewTypeEnum.LAST">
                <ng-container *ngFor="let channel of history">
                    <button class="btn btn-sm p-2" (click)="selectChannelFromHistory(channel)">
                        <img [title]="channel.name" class="me-2 w-100 history_img" [src]="channel.logo">
                    </button>
                </ng-container>
            </ng-container>
            <ng-container *ngIf="gridViewForm.get('gridViewType')?.value===GridViewTypeEnum.TOP">
                <ng-container *ngFor="let channelViews of topList">
                    <button class="btn btn-sm p-2" (click)="selectChannelFromHistory(channelViews.channel)">
                        <img [title]="channelViews.channel.name + ' ('+channelViews.views+' views)'" class="me-2 w-100 history_img" [src]="channelViews.channel.logo">
                    </button>
                </ng-container>
            </ng-container>
        </div>
</ng-template>
<!-- Direct access Template-->

<!-- Player Template-->
<ng-template let-url="url" let-format="format" let-youtubeId="youtubeId" let-logo="logo" let-mosaic="mosaic" #player>
    <ng-container *ngIf="url && format">

        <ng-container *ngIf="format===MediaTypesEnum.M3U8">
            <ng-container *ngIf="isWindows || isAndroid || isMac">
                <vg-player>
                    <video #myMedia
                           [vgHls]="url"
                           [vgHlsHeaders]="headers"
                           (onGetBitrates)="hlsBitrates = $event"
                           id="my-video-{{logo}}"
                           type="video/mp4"
                           preload="metadata"
                           [muted]="true"
                           [autoplay]="true"
                           autoplay
                           controls>
                    </video>
                </vg-player>
            </ng-container>

            <ng-container *ngIf="isIOS">
                <vg-player>
                    <video #myMedia
                           [vgHls]="url"
                           [vgHlsHeaders]="headers"
                           (onGetBitrates)="hlsBitrates = $event"
                           id="my-video"
                           type="video/mp4"
                           preload="metadata"
                           [muted]="true"
                           [autoplay]="true"
                           autoplay
                           controls>
                    </video>
                </vg-player>
            </ng-container>
        </ng-container>

        <ng-container *ngIf="format===MediaTypesEnum.MP3">
            <div class="d-flex flex-column audio-player-container justify-content-start align-items-start p-5">
                <img *ngIf="logo && logo.length>0" class="radio_img m-2" [src]="logo">
                <vg-player>
                    <ng-container *ngIf="!mosaic">
                        <audio #myMedia id="my-audio" [muted]="false" [autoplay]="true" autoplay controls>
                            <source [src]="url" [type]="'audio/mp3'">
                        </audio>
                    </ng-container>
                    <ng-container *ngIf="mosaic">
                        <audio #myMedia id="my-audio" [muted]="true" [autoplay]="false">
                            <source [src]="url" [type]="'audio/mp3'">
                        </audio>
                    </ng-container>
                </vg-player>
            </div>
        </ng-container>

        <ng-container *ngIf="format===MediaTypesEnum.YOUTUBE && youtubeId">
            <youtube-player [videoId]="youtubeId"></youtube-player>
        </ng-container>
        
    </ng-container>
</ng-template>
<!-- End Player Template-->

<!-- Mosaic Template-->
<ng-template #mosaic>
    <div class="d-flex justify-content-around align-items-center gap-1 h-100 flex-wrap w-100">
        <ng-container *ngFor="let channel of history">
            <div class="tv-multiple-screen d-flex justify-content-center align-items-center" title="{{channel.name}} ({{getFormat(channel.options[0].url)}})">
                <ng-container [ngTemplateOutlet]="player" [ngTemplateOutletContext]="{
                    url: channel.options[0].url,
                    format: getFormat(channel.options[0].url),
                    youtubeId: getYoutubeId(channel.options[0].url),
                    logo: channel.logo,
                    mosaic: true
                }"></ng-container>
            </div>
        </ng-container>
    </div>
</ng-template>
<!-- Mosaic Template-->